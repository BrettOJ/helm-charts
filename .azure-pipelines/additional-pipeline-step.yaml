- script: |
    set -e
    export HELM_EXPERIMENTAL_OCI=1
    acrLoginServer="$(acrLoginServer)"

    echo "üì¶ Locating Helm charts in root folders..."

    # üîç Find all chart directories at the repo root
    CHART_DIRS=$(find . -maxdepth 2 -type f -name "Chart.yaml" -exec dirname {} \; | grep -vE '^\./\.|^\.$' | sort -u)

    if [ -z "$CHART_DIRS" ]; then
      echo "‚ö†Ô∏è No chart folders with Chart.yaml found ‚Äî skipping helm push"
      exit 0
    fi

    for dir in $CHART_DIRS; do
      CHART_FILE="$dir/Chart.yaml"
      VALUES_FILE="$dir/values.yaml"
      BACKUP_FILE="$VALUES_FILE.bak"

      if [ ! -f "$CHART_FILE" ] || [ ! -f "$VALUES_FILE" ]; then
        echo "‚ö†Ô∏è  Missing Chart.yaml or values.yaml ‚Äî skipping $dir"
        continue
      fi

      CHART_NAME=$(yq '.name' "$CHART_FILE")
      CHART_VERSION=$(yq '.version' "$CHART_FILE")

      if [[ -z "$CHART_NAME" || "$CHART_NAME" == "null" || -z "$CHART_VERSION" || "$CHART_VERSION" == "null" ]]; then
        echo "‚ö†Ô∏è  Invalid Chart.yaml (missing name or version) ‚Äî skipping $dir"
        continue
      fi

      # üéØ Get current image repository + tag
      ORIG_REPO=$(yq '.image.repository' "$VALUES_FILE")
      IMAGE_TAG=$(yq '.image.tag' "$VALUES_FILE")

      if [[ "$ORIG_REPO" == "null" || "$IMAGE_TAG" == "null" || -z "$ORIG_REPO" || -z "$IMAGE_TAG" ]]; then
        echo "‚ö†Ô∏è  Cannot update image path ‚Äî missing .image.repository or .image.tag in $VALUES_FILE"
        continue
      fi

      # üîÅ Conditionally rewrite repository ONLY if it‚Äôs not already pointing to your ACR
      if [[ "$ORIG_REPO" != "$acrLoginServer"* ]]; then
        NEW_REPO="$acrLoginServer/$(basename "$ORIG_REPO")"
        echo "üõ†Ô∏è Rewriting image.repository to $NEW_REPO in $VALUES_FILE"
        
        # üõü Backup original values.yaml
        cp "$VALUES_FILE" "$BACKUP_FILE"

        # üß† Update values.yaml with ACR reference
        yq -i ".image.repository = \"$NEW_REPO\"" "$VALUES_FILE"
      else
        echo "‚úÖ image.repository already points to ACR ‚Äî no rewrite needed"
      fi

      # ‚úÖ Lint chart
      echo "üîç Running helm lint on $dir"
      helm lint "$dir" || {
        echo "‚ùå Helm lint failed ‚Äî skipping $dir"
        # üßπ Restore original file if modified
        [ -f "$BACKUP_FILE" ] && mv "$BACKUP_FILE" "$VALUES_FILE"
        continue
      }

      # üì¶ Package and push
      CHART_PACKAGE="${CHART_NAME}-${CHART_VERSION}.tgz"

      echo "üì¶ Packaging Helm chart: $CHART_NAME ($CHART_VERSION)"
      helm package "$dir"

      echo "üì§ Pushing chart to ACR: oci://${acrLoginServer}/helm/$CHART_NAME:$CHART_VERSION"
      helm push "$CHART_PACKAGE" "oci://${acrLoginServer}/helm"

      # üßπ Cleanup
      rm -f "$CHART_PACKAGE"

      # üßº Restore original values.yaml if we modified it
      if [ -f "$BACKUP_FILE" ]; then
        echo "üßº Restoring original values.yaml"
        mv "$BACKUP_FILE" "$VALUES_FILE"
      fi
    done
  displayName: 'Update Image Repo, Lint, Package, and Push Helm Charts to ACR'
